<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –ö–æ–º–∞–Ω–¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: #f8fafc;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr;
        }
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 2fr;
            }
        }
        .card {
            background-color: #1a1a1a;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        input, select {
            background-color: #1a1a1a;
            border: 1px solid #333333;
            color: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #fde047;
            box-shadow: 0 0 0 2px #fde047;
        }
        button {
            background-color: #1a1a1a;
            color: #f8fafc;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid #fde047;
            transition: all 0.2s;
            cursor: pointer;
        }
        button:hover {
            background-color: #333333;
        }
        .results h2 {
            margin-bottom: 1rem;
        }
        .team-card {
            background-color: #1a1a1a;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .team-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .error-message {
            color: #ef4444;
            margin-top: 1rem;
        }
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #e2e8f0;
            font-size: 1.5rem;
            transition: color 0.2s;
            line-height: 1;
        }
        .delete-btn:hover {
            color: #fde047;
        }
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100vh;
        }
        .login-screen button {
            padding: 1rem 2rem;
            font-size: 1.25rem;
        }
        .admin-panel {
            background-color: #2a2a2a;
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-screen">
        <h1 class="text-4xl font-bold mb-8">–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –ö–æ–º–∞–Ω–¥</h1>
        <p class="text-lg mb-6 text-gray-400">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø.</p>
        <button onclick="signInWithGoogle()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    </div>

    <div id="access-pending" class="login-screen hidden">
        <h1 class="text-4xl font-bold mb-8">–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</h1>
        <p class="text-lg mb-6 text-gray-400">–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ–¥–æ–±—Ä–∏—Ç –≤–∞—à –∑–∞–ø—Ä–æ—Å. –°–ø–∞—Å–∏–±–æ!</p>
        <button onclick="signOutUser()">–í—ã–π—Ç–∏</button>
    </div>

    <div id="main-content" class="container lg:grid-cols-[1fr_2fr] hidden">
        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="card">
            <h1 class="text-3xl font-bold mb-6 text-center">–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –∫–æ–º–∞–Ω–¥</h1>
            <p class="text-xs text-gray-400 mb-4 text-center">
                –í–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="user-id">...</span>
                <button onclick="signOutUser()" class="delete-btn float-right">–í—ã–π—Ç–∏</button>
            </p>
            
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="player-name" placeholder="–ù–∏–∫–Ω–µ–π–º">
                    <select id="player-role">
                        <option value="Guardian">Guardian</option>
                        <option value="Titan">Titan</option>
                        <option value="Legend">Legend</option>
                        <option value="Divine">Divine</option>
                        <option value="Recruit">Recruit</option>
                        <option value="Knight">Knight</option>
                        <option value="Archon">Archon</option>
                        <option value="Lord">Lord</option>
                    </select>
                    <input type="number" id="player-rating" placeholder="–†–µ–π—Ç–∏–Ω–≥">
                </div>
                <button onclick="addPlayer()" class="w-full">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ (<span id="player-count">0</span>)</h2>
                <div id="player-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Players will be added here -->
                </div>
            </div>
            
            <div class="mb-6">
                <label for="players-per-team" class="block mb-2 text-lg font-medium">–ò–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ</label>
                <input type="number" id="players-per-team" value="5" min="1">
            </div>

            <button onclick="balanceTeams()" class="w-full">–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å</button>
            <p id="error-message" class="error-message hidden"></p>

            <div id="admin-panel" class="admin-panel hidden">
                <h2 class="text-xl font-semibold mb-2">–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å—Ç—É–ø</h2>
                <div id="pending-users-list" class="space-y-2">
                    <!-- Pending users will be listed here -->
                </div>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="card results">
            <h2 class="text-3xl font-bold mb-4 text-center">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <div id="results-output" class="text-lg">
                <p class="text-center text-gray-200">–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä–æ–∫–æ–≤ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // **–í–ê–ñ–ù–û**: –ó–∞–º–µ–Ω–∏—Ç–µ 'nikitalodatok2005@gmail.com' –Ω–∞ —Å–≤–æ–∏ –ø–æ—á—Ç—ã.
        // –ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—á—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∞—Å—Å–∏–≤.
        const adminEmails = ['nikitalodatok2005@gmail.com', '–ø–æ—á—Ç–∞2@example.com', '–ø–æ—á—Ç–∞3@example.com'];
        
        // Global variables for players list and user ID
        let players = [];
        let userId = '';

        // Normalization factors for roles
        const normalizationFactors = {
            'Titan': 7,
            'Legend': 3,
            'Divine': 4,
            'Recruit': 0.5,
            'Knight': 1.7,
            'Archon': 2.7,
            'Lord': 4,
            'Guardian': 1,
        };

        const roleEmojis = {
            'Titan': '‚öîÔ∏è',
            'Legend': '‚≠ê',
            'Divine': 'üëë',
            'Recruit': 'üë∂',
            'Knight': 'üõ°Ô∏è',
            'Archon': 'üèπ',
            'Lord': 'üßô‚Äç‚ôÇÔ∏è',
            'Guardian': 'üíé',
        };

        // Authenticate user and set up Firestore listener
        onAuthStateChanged(auth, async (user) => {
            const mainContent = document.getElementById('main-content');
            const loginScreen = document.getElementById('login-screen');
            const accessPending = document.getElementById('access-pending');
            const adminPanel = document.getElementById('admin-panel');

            if (user) {
                userId = user.uid;
                document.getElementById('user-id').textContent = userId;

                // Check if user is an admin or approved
                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const userDocRef = doc(usersRef, user.uid);
                
                const isAdmin = adminEmails.includes(user.email);

                if (isAdmin) {
                    // Admin gets full access and can see all users
                    adminPanel.classList.remove('hidden');
                    mainContent.classList.remove('hidden');
                    loginScreen.classList.add('hidden');
                    accessPending.classList.add('hidden');
                    setupAdminListener();
                    setupFirestoreListener();
                } else {
                    // Check if user is already approved
                    onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data().isApproved) {
                            mainContent.classList.remove('hidden');
                            loginScreen.classList.add('hidden');
                            accessPending.classList.add('hidden');
                            adminPanel.classList.add('hidden');
                            setupFirestoreListener();
                        } else {
                            // User is not approved, show pending screen
                            mainContent.classList.add('hidden');
                            loginScreen.classList.add('hidden');
                            accessPending.classList.remove('hidden');
                            // Create or update user doc for admin to approve
                            setDoc(userDocRef, { 
                                email: user.email, 
                                isApproved: false, 
                                requested_at: new Date() 
                            }, { merge: true });
                        }
                    });
                }
            } else {
                loginScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                accessPending.classList.add('hidden');
                adminPanel.classList.add('hidden');
            }
        });

        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Firebase auth error:", error);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        }

        function setupAdminListener() {
            const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
            const pendingUsersList = document.getElementById('pending-users-list');

            onSnapshot(usersRef, (snapshot) => {
                pendingUsersList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    if (!user.isApproved) {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-700';
                        userDiv.innerHTML = `
                            <span>${user.email}</span>
                            <button onclick="approveUser('${docSnap.id}')" class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">–û–¥–æ–±—Ä–∏—Ç—å</button>
                        `;
                        pendingUsersList.appendChild(userDiv);
                    }
                });
            });
        }

        async function approveUser(userIdToApprove) {
            const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, userIdToApprove);
            try {
                await setDoc(userDocRef, { isApproved: true }, { merge: true });
            } catch (error) {
                console.error("Error approving user:", error);
            }
        }

        // Set up real-time listener for players from Firestore
        function setupFirestoreListener() {
            const playersColRef = collection(db, `artifacts/${appId}/public/data/players`);
            onSnapshot(playersColRef, (snapshot) => {
                players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updatePlayerList();
            });
        }
        
        function updatePlayerList() {
            const listContainer = document.getElementById('player-list');
            listContainer.innerHTML = '';
            players.forEach((player) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex justify-between items-center bg-transparent p-2 rounded-lg transition-colors duration-200 hover:bg-gray-800';
                playerDiv.innerHTML = `
                    <span>${roleEmojis[player.role] || ''} ${player.name} (${player.role}): ${player.rating}</span>
                    <button onclick="removePlayer('${player.id}')" class="delete-btn">&times;</button>
                `;
                listContainer.appendChild(playerDiv);
            });
            document.getElementById('player-count').textContent = players.length;
        }
        
        // Remove player from Firestore
        async function removePlayer(playerId) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/players`, playerId));
            } catch (error) {
                console.error("Error removing player: ", error);
            }
        }

        // Add player to Firestore
        async function addPlayer() {
            const name = document.getElementById('player-name').value.trim();
            const role = document.getElementById('player-role').value;
            const rating = parseInt(document.getElementById('player-rating').value, 10);
            const errorMessage = document.getElementById('error-message');

            if (!name || isNaN(rating) || rating <= 0) {
                errorMessage.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.';
                errorMessage.classList.remove('hidden');
                return;
            }

            errorMessage.classList.add('hidden');
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/players`), {
                    name,
                    role,
                    rating,
                    created_at: new Date()
                });
            } catch (error) {
                console.error("Error adding player: ", error);
            }
            
            // Clear inputs
            document.getElementById('player-name').value = '';
            document.getElementById('player-rating').value = '';
        }
        
        function normalizeRatings(players) {
            return players.map(player => {
                const normalizedPlayer = { ...player };
                const factor = normalizationFactors[player.role] || 1;
                normalizedPlayer.normalized_rating = player.rating / factor;
                return normalizedPlayer;
            });
        }

        function balanceTeams() {
            const playersPerTeam = parseInt(document.getElementById('players-per-team').value, 10);
            const errorMessage = document.getElementById('error-message');

            if (players.length === 0) {
                errorMessage.textContent = '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.';
                errorMessage.classList.remove('hidden');
                return;
            }

            if (playersPerTeam <= 0) {
                errorMessage.textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.';
                errorMessage.classList.remove('hidden');
                return;
            }

            errorMessage.classList.add('hidden');
            
            const normalizedPlayers = normalizeRatings(players);
            const sortedPlayers = normalizedPlayers.sort((a, b) => b.normalized_rating - a.normalized_rating);
            
            const numTeams = Math.ceil(players.length / playersPerTeam);
            const teams = Array.from({ length: numTeams }, () => []);
            
            for (let i = 0; i < sortedPlayers.length; i++) {
                const teamIndex = i % numTeams;
                teams[teamIndex].push(sortedPlayers[i]);
            }

            displayResults(teams, numTeams, playersPerTeam);
        }

        function displayResults(teams, numTeams, playersPerTeam) {
            const outputDiv = document.getElementById('results-output');
            outputDiv.innerHTML = `
                <p>–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤: ${players.length}</p>
                <p>–ò–≥—Ä–æ–∫–æ–≤ –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ: ${playersPerTeam}</p>
                <p>–ë—É–¥–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–∞–Ω–¥: ${numTeams}</p>
                <br>
                <h3 class="text-xl font-bold">--- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ ---</h3>
            `;
            
            const allTeamRatings = [];
            teams.forEach((team, index) => {
                let totalRating = 0;
                const teamHtml = team.map(player => {
                    totalRating += player.rating;
                    return `<span class="block">${roleEmojis[player.role] || ''} ${player.name} (${player.role}): ${player.rating}</span>`;
                }).join('');
                
                allTeamRatings.push(totalRating);
                
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                teamCard.innerHTML = `
                    <h3>–ö–æ–º–∞–Ω–¥–∞ ${index + 1}:</h3>
                    <div class="space-y-2 mt-2">${teamHtml}</div>
                    <p class="font-bold mt-2">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: ${totalRating}</p>
                `;
                outputDiv.appendChild(teamCard);
            });
            
            if (allTeamRatings.length > 1) {
                const minRating = Math.min(...allTeamRatings);
                const maxRating = Math.max(...allTeamRatings);
                const difference = maxRating - minRating;
                
                const differenceP = document.createElement('p');
                differenceP.className = 'mt-4 text-yellow-400 font-bold';
                differenceP.innerHTML = `–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —Å–∞–º—ã–º –≤—ã—Å–æ–∫–∏–º –∏ —Å–∞–º—ã–º –Ω–∏–∑–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –∫–æ–º–∞–Ω–¥—ã: ${difference}`;
                outputDiv.appendChild(differenceP);
            }
        }
    </script>
</body>
</html>
